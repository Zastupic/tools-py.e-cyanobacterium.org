{% extends "base.html" %}

{% block title %}
    Online Statistical Data Analyzer | CyanoTools
{% endblock %}

{% block description %}
    Free statistical tool for biological datasets. Generate box plots with swarm overlays, run PCA, and perform normality tests and ANOVA on wet-lab data instantly.
{% endblock %}

{% block keywords %}
    Online statistics for biology,  Statistical analysis, box plot generator, PCA analysis online, ANOVA assumptions test, biological data visualization, experimental data analysis, free statistical software, Shapiro-Wilk test, Levene test, Tukey HSD, ANOVA calculator, Kruskal-Wallis test, effect size calculation, statistical power analysis, bioinformatics tools, data analysis software
{% endblock %}

{% block extra_schema %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "CyanoTools Statistics Beta",
  "operatingSystem": "Web",
  "applicationCategory": "BusinessApplication",
  "description": "Statistical tool for wet-lab data: ANOVA, Kruskal-Wallis, and automated visualization of physiological assays.",
  "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
  "featureList": "Multi-factor grouping, Significance testing, Instant boxplots and bar charts"
}
</script>
{% endblock %}

{% block content %}
<style>
    /* Main tab rows: active tab light blue, spacing between row1 and row2 */
    #statsTabRow1 .nav-link,
    #statsTabRow2 .nav-link { border: 1px solid #dee2e6 !important; margin-right: 2px; }
    #statsTabRow1 .nav-link.active,
    #statsTabRow2 .nav-link.active { background-color: #cce5ff !important; color: #004085; border-color: #b8daff !important; }
    #statsTabRow1 { margin-bottom: 0.5rem; }
    #statsTabRow2 { margin-top: 0.5rem; margin-bottom: 0; padding-top: 0.25rem; border-top: 1px solid #dee2e6; }
    /* Significance Tests same style as other tabs (no green) */
    #anova-tab.text-success { color: #495057 !important; }
    #anova-tab.nav-link.active { color: #004085 !important; }
    /* Assumptions sub-tabs: border and active light blue */
    #assumptionsSubTabs .nav-link { border: 1px solid #dee2e6; margin-right: 4px; }
    #assumptionsSubTabs .nav-link.active { background-color: #cce5ff !important; color: #004085; border-color: #b8daff !important; }
    /* Assumption plots: fit inside card, no overflow */
    .assumptions-plot-container { overflow: hidden; max-width: 100%; width: 100%; }
    .assumptions-plot-container .plotly { width: 100% !important; max-width: 100% !important; }
    #assumptionsBoxPlots .assumptions-plot-container,
    #assumptionsResidualsContent .assumptions-plot-container,
    #assumptionsQQContent .assumptions-plot-container { height: 320px; min-height: 320px; }
    /* Assumptions sub-tabs: base and heading sizes */
    #assumptionsSubTabContent { font-size: 0.72rem; }
    #assumptionsSubTabContent h5 { font-size: 0.95rem; }
    #assumptionsSubTabContent h6 { font-size: 0.82rem; }
    #assumptionsSubTabContent .badge { font-size: 0.62rem; }
    /* Summary (normality) table: larger for readability */
    #testResults .table { font-size: 0.84rem; }
    /* Box plots / residuals / Q-Q tables: keep compact */
    #assumptionsBoxPlots .table,
    #assumptionsResidualsContent .table,
    #assumptionsQQContent .table { font-size: 0.70rem; }
    /* Grey info boxes in every sub-tab: smaller than body text */
    #assumptionsSubTabContent .alert-secondary { font-size: 0.60rem !important; }
</style>
<div class="page-wrapper">
    <div class="wrapper-box">
        <!-- Hero Section -->
        <div class="row mb-4 w-100">
            <div class="col-12">
                <div class="p-4 border rounded shadow-sm bg-white">
                    <h2 class="fw-bold mb-3">
                        <i class="bi bi-graph-up-arrow"></i> Statistics Tool
                    </h2>
                    <p class="lead mb-4" style="font-size: 1.1rem;">
                        Streamline analysis of wet-lab cultivation experiments and physiological assays. 
                        Process complex datasets with multi-factor grouping, descriptive statistics, and instant visualizations.
                    </p>
                    <!-- Key Features Grid -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3 col-sm-6">
                            <div class="p-3 bg-light rounded h-100">
                                <h6 class="fw-bold text-primary mb-2">
                                    <i class="bi bi-layers"></i> Multi-Factor Analysis
                                </h6>
                                <p class="small mb-0 text-muted">Group by up to 3 factors for comprehensive cross-variable insights</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="p-3 bg-light rounded h-100">
                                <h6 class="fw-bold text-primary mb-2">
                                    <i class="bi bi-cpu"></i> Smart Data Parsing
                                </h6>
                                <p class="small mb-0 text-muted">Handles scientific notation and auto-strips units (e.g., "h‚Åª¬π")</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="p-3 bg-light rounded h-100">
                                <h6 class="fw-bold text-primary mb-2">
                                    <i class="bi bi-bar-chart"></i> Rich Visualizations
                                </h6>
                                <p class="small mb-0 text-muted">Box plots with swarm overlays plus instant N, Mean, Std Dev</p>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="p-3 bg-light rounded h-100">
                                <h6 class="fw-bold text-primary mb-2">
                                    <i class="bi bi-file-earmark-excel"></i> Easy Export
                                </h6>
                                <p class="small mb-0 text-muted">Download complete analysis reports as .xlsx files</p>
                            </div>
                        </div>
                    </div>
                    <!-- Collapsible Data Requirements (Bootstrap 4) -->
                    <div class="accordion" id="requirementsAccordion">
                        <div class="card">
                            <div class="card-header" id="headingRequirements">
                                <h5 class="mb-0">
                                    <button class="btn btn-link collapsed w-100 text-left" type="button" data-toggle="collapse" data-target="#dataRequirements" aria-expanded="false" aria-controls="dataRequirements">
                                        <i class="bi bi-info-circle mr-2"></i> Data Requirements & Best Practices
                                    </button>
                                </h5>
                            </div>
                            <div id="dataRequirements" class="collapse" aria-labelledby="headingRequirements" data-parent="#requirementsAccordion">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="font-weight-bold mb-2">Required Format:</h6>
                                            <ol class="small">
                                                <li><strong>Long Tabular Structure:</strong> One observation per row</li>
                                                <li><strong>Numeric Consistency:</strong> Values must be numeric (units auto-handled)</li>
                                                <li><strong>Independent Measurements:</strong> Each data point should be independent</li>
                                                <li><strong>Discrete Factors:</strong> Use clear categorical variables for grouping</li>
                                            </ol>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="alert alert-info mb-0">
                                                <strong><i class="bi bi-lightbulb"></i> Current Status:</strong>
                                                <p class="small mb-0 mt-2">Optimized for data visualization and basic satistics. ANOVA and advanced statistical tests are under development.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Example Data Download Button Inside Accordion -->
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <hr class="my-3">
                                            <div class="text-center">
                                                <p class="small text-muted mb-2">Need a sample dataset to get started?</p>
                                                <a href="{{url_for('static', filename='files/ExampleStatisticsData.xlsx')}}" 
                                                   class="btn btn-outline-primary btn-sm" 
                                                   download>
                                                    <i class="bi bi-download mr-1"></i> Download Example Dataset
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Main Work Area -->
        <div class="row w-100">
            <!-- Left Panel: Data Input -->
            <div class="col-md-4">
                <div class="p-3 border rounded shadow-sm bg-light">
                    <h5 class="fw-bold border-bottom pb-2 mb-3">
                        <span class="badge bg-primary me-2">1</span> Data Input
                    </h5>
                    <p class="small text-muted mb-3">
                        Copy-paste date from an Excel file, or paste Tab-delimited data
                    </p>
                    <p class="small text-muted mb-2">
                        <i class="bi bi-info-circle"></i> Maximum: 100 rows, 50 columns
                    </p>
                    <textarea id="excelPasteBox" class="form-control mb-2" rows="6" 
                              placeholder="Paste your Excel data with headers here..."></textarea>
                    <div id="dataLimitError" class="alert alert-danger small py-2 mb-3" role="alert" style="display: none;"></div>
                    <button id="processDataBtn" class="btn btn-primary w-100 fw-bold shadow-sm">
                        <i class="bi bi-upload"></i> Load Data
                    </button>
                    <!-- Selection Card (hidden initially) -->
                    <div id="selectionCard" class="mt-4" style="display:none;">
                        <h5 class="fw-bold border-bottom pb-2 mb-3">
                            <span class="badge bg-primary me-2">2</span> Select Categirical Factors
                        </h5>
                        <p class="small text-muted mb-3">
                            Choose up to 3 factors to categorize your data
                        </p>
                        
                        <div class="mb-3">
                            <select id="factorSelector" class="form-control form-control-sm">
                                <option value="">-- Choose Factor --</option>
                            </select>
                        </div>
                        <div id="activeFactorsContainer" class="d-flex flex-column gap-2 mb-4"></div>
                        <h5 class="fw-bold border-bottom pb-2 mb-3">
                            <span class="badge bg-primary me-2">3</span> Select Variables
                        </h5>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="selectAllVars">
                            <label class="form-check-label small fw-bold" for="selectAllVars">
                                Select All Variables
                            </label>
                        </div>
                        
                        <div id="checkboxContainer" class="mb-3" 
                             style="max-height: 300px; overflow-y: auto; padding-right: 5px;"></div>
                        <button id="updateAnalysisBtn" class="btn btn-success w-100 fw-bold shadow-sm">
                            <i class="bi bi-play-fill"></i> Confirm Selection & Start Analyses
                        </button>
                    </div>
                </div>
            </div>
            <!-- Right Panel: Results -->
            <div class="col-md-8">
                <!-- Results Area (hidden initially) -->
                <div id="resultsArea" style="display: none;">
                    <!-- Row 1: Main analyses (Visualizations, Assumptions, Significance Tests) -->
                    <ul class="nav nav-tabs border-bottom-0 mb-3" id="statsTabRow1" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active fw-bold border" id="viz-tab" data-toggle="tab" data-target="#viz-content" role="tab"><i class="bi bi-bar-chart-line"></i> Visualizations</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold border" id="assumptions-tab" data-toggle="tab" data-target="#assumptions-content" role="tab"><i class="bi bi-calculator"></i> ANOVA Assumptions</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold border" id="anova-tab" data-toggle="tab" data-target="#anova-content" role="tab" style="display: none;"><i class="bi bi-list-check"></i> ANOVA Tests</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link fw-bold border" id="pca-tab" data-toggle="tab" data-target="#pca-content" role="tab"><i class="bi bi-grid-3x3-gap"></i> Multivariate (PCA)</button>
                        </li>
                    </ul>

                    <hr class="my-2 border-secondary" style="opacity: 0.35;">
                    <div class="tab-content border p-3 rounded-bottom rounded-top bg-white shadow-sm" id="statsTabContent">
                        <div class="tab-pane fade show active" id="viz-content" role="tabpanel">
                            <div class="p-3">
                                <h5 class="fw-bold mb-3">Data Visualizations</h5>
                                <p class="text-muted small">Generate box plots with swarm overlays for selected variables grouped by factors.</p>
                                <small class="text-muted d-block mb-3">
                                    <strong>What‚Äôs in the plots:</strong><br>
                                    ‚Ä¢ Dots (swarm): one dot = one data point; jittered horizontally to avoid overlap.<br>
                                    ‚Ä¢ Box: IQR (interquartile range ‚Äî middle 50% of values); line inside = median.<br>
                                    ‚Ä¢ Whiskers: extend to 1.5√ó IQR from box; points beyond are not shown.<br>
                                    ‚Ä¢ Box color: factor group (matches legend).
                                    <br><br>
                                    <strong>Outlier Identification and Interactive Cleaning:</strong><br>
                                    ‚Ä¢ Points falling beyond the whiskers (1.5√ó IQR) are automatically flagged as <span class="text-danger"><strong>red dots</strong></span>.<br>
                                    ‚Ä¢ You can <strong>click</strong> on any red outlier to permanently exclude it from the dataset and re-calculate all statistics.<br>
                                    ‚Ä¢ It is highly recommended to identify and remove outliers <strong>before</strong> beginning the significance analysis (ANOVA) to ensure the validity and robustness of your results.
                                </small>
                                <div class="d-flex align-items-center mb-4 flex-wrap" style="gap: 1rem;">
                                    <button id="runVizBtn" class="btn btn-primary btn-sm">
                                        <i class="bi bi-play-fill"></i> Run Visualizations
                                    </button>
                                    <div id="vizResultsHeader" style="display:none;" class="ms-2">
                                        <button id="downloadExcelBtn" class="btn btn-outline-success btn-sm">
                                            <i class="bi bi-file-earmark-excel"></i> Download Results
                                        </button>
                                        <span id="vizExportSpinner" style="display:none;" class="ms-2">
                                            <span class="spinner-border spinner-border-sm text-success" role="status"></span>
                                            <span class="small text-muted ms-1">Generating‚Ä¶</span>
                                        </span>
                                    </div>
                                </div>
                            
                                <div id="loadingSpinner" class="loader-container" style="display: none;">
                                    <div class="custom-spinner"></div>
                                </div>
                            
                                <div id="statsContent" class="row"></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="assumptions-content" role="tabpanel">
                            <div class="p-3">
                                <div class="alert alert-info border-0 shadow-sm mb-4">
                                    <h6 class="fw-bold d-flex align-items-center"><i class="bi bi-calculator-fill me-2"></i> Tests Performed</h6>
                                    <p class="small mb-2">Before any significance test can be run, the data must satisfy two statistical assumptions required by ANOVA. This section runs those two tests automatically for each selected variable:</p>
                                    <div class="row g-3 mt-1">
                                        <div class="col-md-6">
                                            <div class="p-2 bg-white rounded-3 border-start border-4 border-primary">
                                                <p class="small mb-1"><strong>1. Shapiro-Wilk (Normality)</strong></p>
                                                <p class="extra-small text-muted mb-0">Checks if each group follows a <strong>Normal Distribution</strong>. If <span class="badge bg-light text-dark">p &gt; 0.05</span>, the data is likely normal (Assumption Met).</p>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="p-2 bg-white rounded-3 border-start border-4 border-info">
                                                <p class="small mb-1"><strong>2. Levene's Test (Homogeneity)</strong></p>
                                                <p class="extra-small text-muted mb-0">Checks if <strong>Variances</strong> are equal across groups. If <span class="badge bg-light text-dark">p &gt; 0.05</span>, variances are consistent (Assumption Met).</p>
                                            </div>
                                        </div>
                                    </div>
                                    <hr class="my-2" style="opacity:0.25;">
                                    <p style="font-size:0.70rem;" class="mb-1 text-muted"><strong><i class="bi bi-signpost-split me-1"></i> Next step ‚Äî ANOVA Tests tab:</strong> Results here determine which significance test is most appropriate. In the <em>ANOVA Tests</em> tab you can either let the tool <strong>select automatically</strong> based on these results, or <strong>choose a parametric or non-parametric test manually</strong>. The automated logic is: Both passed ‚Üí <strong>One-way ANOVA</strong> + Tukey HSD; Only normality ‚Üí <strong>Welch's ANOVA</strong> + Games-Howell (BH); Only homogeneity ‚Üí <strong>Kruskal‚ÄìWallis</strong> + Dunn's (BH); Neither ‚Üí <strong>Kruskal‚ÄìWallis</strong> + Dunn's (BH).</p>
                                </div>
                        
                                <button id="runTestsBtn" class="btn btn-primary btn-sm mb-4"><i class="bi bi-play-fill"></i> Run Normality &amp; Variance Tests</button>
                        
                                <div id="testSpinner" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2 text-muted small">Performing statistical calculations...</p>
                                </div>

                                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRANSFORMATION PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                                <div id="transformationPanel" class="mt-3 mb-3" style="display:none;">
                                    <div class="card shadow-sm" style="border: 1px solid #ffc107; border-left: 4px solid #fd7e14;">
                                        <div class="card-header py-2 px-3 d-flex align-items-center justify-content-between"
                                             style="background: linear-gradient(to right, #fff8e1, #fff3e0); border-bottom: 1px solid #ffe082;">
                                    <div>
                                                <p class="fw-bold mb-0 text-dark" style="font-size:0.85rem;">
                                                    <i class="bi bi-arrow-left-right text-warning me-1"></i> Data Transformations
                                                    <span id="transformActiveBadge" class="badge bg-warning text-dark ms-2"
                                                          style="display:none; font-size:0.65rem; vertical-align:middle;">
                                                        <i class="bi bi-check-circle-fill me-1"></i> Transformations Applied
                                                    </span>
                                                </p>
                                                <p class="mb-0 mt-1 text-muted" style="font-size:0.72rem;">
                                                    Apply mathematical transformations per variable to improve normality or homogeneity before ANOVA.
                                                </p>
                                                <p class="mb-0 mt-1" style="font-size:0.68rem; color:#856404;">
                                                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                                    <strong>Note:</strong> Transformations are most reliable when n&nbsp;‚â•&nbsp;5 per group. With smaller sample sizes the normality and homogeneity test results ‚Äî and therefore any suggested transformation ‚Äî should be treated with caution.
                                                </p>
                                            </div>
                                        </div>
                                        <div class="card-body p-3">

                                            <!-- Candidates summary + When to use guide (filled by JS) -->
                                            <div id="transformCandidates" class="mb-2"></div>

                                            <!-- Per-variable transform controls (filled by JS) -->
                                            <div class="rounded border bg-white mb-3" style="overflow:hidden;">
                                                <div class="row g-0 py-1 px-2 border-bottom"
                                                     style="font-size:0.72rem; font-weight:600; color:#6c757d; background:#f8f9fa;">
                                                    <div class="col-3">Variable</div>
                                                    <div class="col-3">Transformation</div>
                                                    <div class="col-2 text-center">Test Status</div>
                                                    <div class="col-2">Suggested</div>
                                                    <div class="col-2">Used</div>
                                                </div>
                                                <div id="transformControls"></div>
                                            </div>

                                            <div class="d-flex align-items-center flex-wrap mt-2" style="gap:1rem;">
                                                <button id="applyTransformBtn" class="btn btn-sm btn-warning fw-bold shadow-sm">
                                                    <i class="bi bi-arrow-repeat me-1"></i> Apply &amp; Re-run Tests
                                                </button>
                                                <button id="resetTransformBtn" class="btn btn-sm btn-outline-secondary">
                                                    <i class="bi bi-x-circle me-1"></i> Reset to Original Data
                                                </button>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

                                <div id="assumptionsResultsArea" style="display: none;">
                                    <ul class="nav nav-pills mb-2 small" id="assumptionsSubTabs" role="tablist">
                                        <li class="nav-item"><a class="nav-link active py-1 px-2" id="assumptions-normality-tab" data-toggle="tab" data-target="#assumptions-normality" href="#assumptions-normality" role="tab">Assumptions Summary</a></li>
                                        <li class="nav-item"><a class="nav-link py-1 px-2" id="assumptions-boxplots-tab" data-toggle="tab" data-target="#assumptions-boxplots" href="#assumptions-boxplots" role="tab">Box Plots</a></li>
                                        <li class="nav-item"><a class="nav-link py-1 px-2" id="assumptions-residuals-tab" data-toggle="tab" data-target="#assumptions-residuals" href="#assumptions-residuals" role="tab">Residuals vs Fitted</a></li>
                                        <li class="nav-item"><a class="nav-link py-1 px-2" id="assumptions-qq-tab" data-toggle="tab" data-target="#assumptions-qq" href="#assumptions-qq" role="tab">Normal Q-Q</a></li>
                                    </ul>
                        
                                    <hr class="my-2 border-secondary" style="opacity: 0.35;">
                        
                                    <div class="tab-content pt-2" id="assumptionsSubTabContent">
                                        
                                        <div class="tab-pane fade show active" id="assumptions-normality" role="tabpanel">
                                            <div class="alert alert-secondary border-0 shadow-sm mb-3 py-2 px-3 alert-info-sm">
                                                <p class="mb-1"><strong><i class="bi bi-table me-1"></i> About this table:</strong> The summary below shows the combined results of two statistical assumption tests run for each variable:</p>
                                                <ul class="mb-1 ps-3">
                                                    <li><strong>Shapiro-Wilk (Normality):</strong> tests whether the data within each group follows a normal distribution. A p&nbsp;&gt;&nbsp;0.05 indicates normality is met.</li>
                                                    <li><strong>Levene's Test (Homogeneity of Variances):</strong> tests whether the spread of values is similar across all groups. A p&nbsp;&gt;&nbsp;0.05 indicates equal variances.</li>
                                                </ul>
                                                <p class="mb-1">Both tests are evaluated together to decide the most appropriate significance test (ANOVA, Welch's ANOVA, or Kruskal-Wallis).</p>
                                                <hr class="my-1" style="opacity:0.3;">
                                                <p class="mb-0"><strong>Explore further in the other sub-tabs:</strong></p>
                                                <ul class="mb-0 ps-3">
                                                    <li><strong>Box Plots:</strong> inspect the raw distribution and spread of individual data points for each variant and variable.</li>
                                                    <li><strong>Residuals vs Fitted:</strong> visually check for homogeneity of variances ‚Äî points should be evenly scattered around the horizontal axis with no pattern.</li>
                                                    <li><strong>Normal Q-Q:</strong> visually assess normality ‚Äî points following the diagonal reference line indicate normally distributed residuals.</li>
                                                </ul>
                                            </div>
                                            <div id="testResults"></div>
                                        </div>
                        
                                        <div class="tab-pane fade" id="assumptions-boxplots" role="tabpanel">
                                            <div class="alert alert-secondary border-0 shadow-sm mb-3 py-2 px-3 alert-info-sm">
                                                <p class="mb-1"><strong><i class="bi bi-box me-1"></i> What these plots show:</strong> One box plot per variant (group) for each variable, showing the full data distribution. Use these to visually inspect whether each group is roughly symmetric and whether spread (variance) differs markedly between groups ‚Äî both key ANOVA assumptions.</p>
                                                <ul class="mb-1 ps-3">
                                                    <li><span style="color:#198754;"><strong>Green</strong></span> ‚Äî group <strong>passed</strong> the Shapiro-Wilk normality test (p&nbsp;&gt;&nbsp;0.05).</li>
                                                    <li><span style="color:#dc3545;"><strong>Red</strong></span> ‚Äî group <strong>failed</strong> the Shapiro-Wilk normality test (p&nbsp;‚â§&nbsp;0.05).</li>
                                                </ul>
                                                <p class="mb-1"><i class="bi bi-info-circle me-1"></i> Color reflects only the <strong>per-group</strong> Shapiro-Wilk result. Levene's test is across all groups simultaneously and is shown in the Assumptions Summary table only.</p>
                                                <p class="mb-0"><strong><i class="bi bi-cursor-fill me-1"></i> Outlier removal:</strong> Points beyond 1.5√ó IQR are flagged as <span class="text-danger"><strong>red dots</strong></span>. <strong>Click any red dot</strong> to permanently exclude it and recalculate. Remove outliers <em>before</em> running ANOVA tests.</p>
                                            </div>
                                            <div id="assumptionsBoxPlots"><p class="text-muted small">Run Normality &amp; Variance Tests to generate plots.</p></div>
                                        </div>
                        
                                        <div class="tab-pane fade" id="assumptions-residuals" role="tabpanel">
                                            <div class="alert alert-secondary border-0 shadow-sm mb-3 py-2 px-3 alert-info-sm">
                                                <p class="mb-1"><strong><i class="bi bi-scatter-chart me-1"></i> Residuals vs Fitted ‚Äî Primary purpose: Homogeneity of Variances</strong></p>
                                                <p class="mb-1">Displays <em>residuals</em> (observed ‚àí group mean) on the Y-axis against <em>fitted values</em> (group means) on the X-axis. Because each group occupies one X position, the vertical spread at each position directly shows within-group variance ‚Äî making it easy to spot whether spread is consistent across groups (Levene's assumption).</p>
                                                <p class="mb-1"><strong>Well-behaved data:</strong> Points scattered <strong>evenly around zero</strong> with similar vertical spread across all groups.<br>
                                                <strong>Warning signs:</strong> <em>Funnel/fan shape</em> ‚Üí unequal variances (heteroscedasticity); <em>Curved trend</em> ‚Üí non-linearity or non-normality; <em>Isolated points far from zero</em> ‚Üí potential outliers.</p>
                                                <hr class="my-1" style="opacity:0.25;">
                                                <p class="mb-1"><strong><i class="bi bi-bullseye me-1"></i> Outlier identification (|z|&nbsp;&gt;&nbsp;2):</strong> Raw residuals are standardized (√∑ SD) to a dimensionless z-score. Points with <strong>|z|&nbsp;&gt;&nbsp;2</strong> ‚Äî beyond the ~95% range of a normal distribution ‚Äî are flagged in <span class="text-danger"><strong>red</strong></span>. Before removing, ask: <em>measurement error?</em> ‚Üí remove; <em>real biological extreme?</em> ‚Üí keep; <em>many points flagged on one side?</em> ‚Üí systematic variance issue, removal won't help; <em>does Levene's p change after removal?</em> ‚Üí re-run to verify.</p>
                                                <p class="mb-0"><strong><i class="bi bi-cursor-fill me-1"></i> Click any <span class="text-danger">red point</span></strong> to exclude it permanently and recalculate. Blue points are not clickable.</p>
                                            </div>
                                            <div id="assumptionsResidualsContent"><p class="text-muted small">Run Normality &amp; Variance Tests to generate plots.</p></div>
                                        </div>
                        
                                        <div class="tab-pane fade" id="assumptions-qq" role="tabpanel">
                                            <div class="alert alert-secondary border-0 shadow-sm mb-3 py-2 px-3 alert-info-sm">
                                                <p class="mb-1"><strong><i class="bi bi-graph-up me-1"></i> Normal Q-Q ‚Äî Primary purpose: Normality of Residuals</strong></p>
                                                <p class="mb-1">Compares the <em>observed quantiles</em> of the residuals (Y-axis) against the <em>theoretical quantiles</em> of a perfect normal distribution (X-axis). If the data is truly normal, both sets of quantiles match and points lie along the diagonal reference line. Deviations reveal exactly where and how the distribution differs from normality.</p>
                                                <p class="mb-1"><strong>Well-behaved data:</strong> Points lie <strong>closely along the diagonal</strong>; small deviations at the ends are acceptable.<br>
                                                <strong>Warning signs:</strong> <em>S-shaped curve</em> ‚Üí heavy/light tails; <em>one-end bend</em> ‚Üí skewness; <em>gaps or jumps</em> ‚Üí bimodality; <em>extreme off-line points</em> ‚Üí outliers.</p>
                                                <hr class="my-1" style="opacity:0.25;">
                                                <p class="mb-1"><strong><i class="bi bi-bullseye me-1"></i> Outlier identification (|std residual|&nbsp;&gt;&nbsp;2):</strong> The Y-axis already shows standardized residuals, so the threshold is readable directly from the plot. Points with <strong>|std residual|&nbsp;&gt;&nbsp;2</strong> ‚Äî beyond the ~95% range expected for normal data ‚Äî are flagged in <span class="text-danger"><strong>red</strong></span>; they also tend to deviate most from the diagonal line. Before removing, ask: <em>measurement error?</em> ‚Üí remove; <em>real biological extreme?</em> ‚Üí keep; <em>consistent pattern across many points (S-curve, bend)?</em> ‚Üí distribution is globally non-normal, removal won't help ‚Äî consider data transformation; <em>does Shapiro-Wilk p pass after removal?</em> ‚Üí re-run to verify.</p>
                                                <p class="mb-0"><strong><i class="bi bi-cursor-fill me-1"></i> Click any <span class="text-danger">red point</span></strong> to exclude it permanently and recalculate. Blue points are not clickable.</p>
                                            </div>
                                            <div id="assumptionsQQContent"><p class="text-muted small">Run Normality &amp; Variance Tests to generate plots.</p></div>
                                        </div>
                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="anova-content" role="tabpanel">
                            <div class="p-3">
                                <h5 class="fw-bold mb-3">Significance Testing</h5>

                                <!-- Decision Guide -->
                                <div class="alert alert-warning border-0 shadow-sm mb-3">
                                    <h6 class="fw-bold"><i class="bi bi-lightbulb-fill"></i> Automated Test Selection Logic</h6>
                                    <p class="small mb-2">The tool selects the best test based on the number of factors and assumption results:</p>
                                    <div class="row g-2 small mb-0">
                                        <div class="col-md-4">
                                            <div class="p-2 bg-white rounded border-start border-3 border-warning">
                                                <div class="fw-bold mb-1" style="font-size:0.75rem;"><i class="bi bi-1-square-fill text-warning me-1"></i> 1 Factor</div>
                                                <div style="font-size:0.70rem;">
                                                    Both passed ‚Üí <strong>One-way ANOVA</strong> + Tukey HSD<br>
                                                    Only normality ‚Üí <strong>Welch's ANOVA</strong> + Games-Howell (BH)<br>
                                                    Only homogeneity ‚Üí <strong>Kruskal‚ÄìWallis</strong> + Dunn's (BH)<br>
                                                    Neither passed ‚Üí <strong>Kruskal‚ÄìWallis</strong> + Dunn's (BH)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="p-2 bg-white rounded border-start border-3 border-warning">
                                                <div class="fw-bold mb-1" style="font-size:0.75rem;"><i class="bi bi-2-square-fill text-warning me-1"></i> 2 Factors</div>
                                                <div style="font-size:0.70rem;">
                                                    Both passed ‚Üí <strong>Two-way ANOVA</strong> + Tukey HSD<br>
                                                    Assumptions fail ‚Üí <strong>Scheirer‚ÄìRay‚ÄìHare</strong> + Dunn's (BH)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="p-2 bg-white rounded border-start border-3 border-warning">
                                                <div class="fw-bold mb-1" style="font-size:0.75rem;"><i class="bi bi-3-square-fill text-warning me-1"></i> 3+ Factors</div>
                                                <div style="font-size:0.70rem;">
                                                    Both passed ‚Üí <strong>MANOVA</strong> (Pillai's Trace) + per-variable ANOVA (Bonferroni)<br>
                                                    Assumptions fail ‚Üí <strong>ART ANOVA</strong> + per-variable follow-up (Bonferroni)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="extra-small text-muted mt-2 mb-0">
                                        <i class="bi bi-info-circle"></i>
                                        Post-hoc comparisons shown only when overall test is significant (p &lt; 0.05). All p-values corrected for multiple comparisons.
                                    </p>
                                </div>

                                <!-- Limitations Notice -->
                                <div class="accordion mb-3" id="limitationsAccordion">
                                    <div class="card shadow-sm" style="border: 1px solid #dee2e6; border-left: 4px solid #6c757d !important;">
                                        <div class="card-header py-2 px-3 bg-light" id="limHead">
                                            <button class="btn btn-link btn-sm p-0 text-secondary text-decoration-none w-100 text-left d-flex align-items-center justify-content-between"
                                                    type="button" data-toggle="collapse" data-target="#limBody" aria-expanded="false">
                                                <span style="font-size:0.78rem;"><i class="bi bi-exclamation-triangle me-1 text-secondary"></i> <strong>Current Limitations ‚Äî Read Before Interpreting Results</strong></span>
                                                <i class="bi bi-chevron-down small text-muted"></i>
                                            </button>
                                        </div>
                                        <div id="limBody" class="collapse" aria-labelledby="limHead">
                                            <div class="card-body py-2 px-3" style="font-size:0.75rem;">
                                                <div class="mb-2">
                                                    <strong><i class="bi bi-x-circle text-danger me-1"></i> Continuous factors not supported.</strong>
                                                    This tool treats all factors as categorical. Dose-response curves, time-series, or any factor with a meaningful numeric ordering (e.g. 0 ¬µM, 10 ¬µM, 100 ¬µM dose) should be analysed with regression or repeated-measures ANOVA in dedicated software (R, SPSS, Prism). Using such data here may produce misleading letter groups.
                                                </div>
                                                <div class="mb-0">
                                                    <strong><i class="bi bi-x-circle text-danger me-1"></i> Hierarchical / nested designs not supported.</strong>
                                                    The tool assumes a fully crossed, independent-groups design. Split-plot, repeated measures, or nested experiments (e.g. multiple technical replicates per biological replicate) require mixed-effects models and are not handled here.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Manual Override Control -->
                                <div class="card border-0 shadow-sm mb-3" style="border: 1px solid #dee2e6 !important;">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                                            <div>
                                                <label class="fw-bold small mb-1 d-block" for="anovaOverrideSelect">
                                                    <i class="bi bi-toggles me-1"></i> Test Selection
                                                </label>
                                                <select id="anovaOverrideSelect" class="form-select form-select-sm" style="min-width:260px; max-width:380px;">
                                                    <option value="auto">ü§ñ Automatic (recommended)</option>
                                                </select>
                                            </div>
                                            <div id="overrideActiveBadge" style="display:none;">
                                                <span class="badge bg-warning text-dark" style="font-size:0.72rem;">
                                                    <i class="bi bi-exclamation-triangle-fill me-1"></i> Automated recommendation overridden
                                                </span>
                                            </div>
                                        </div>
                                        <p class="extra-small text-muted mt-2 mb-0">Override to force a specific test (e.g. run parametric ANOVA even if normality failed). Only do this if you have scientific justification.</p>
                                    </div>
                                </div>

                                <div id="groupingModeContainer" class="mt-2" style="display: none;">
                                    <div class="card border-success bg-light shadow-sm">
                                        <div class="card-body p-3">
                                            <h6 class="fw-bold text-success mb-2"><i class="bi bi-diagram-3"></i> Post-hoc Grouping Mode</h6>
                                            <select id="groupingMode" class="form-select form-select-sm border-success">
                                                </select>
                                            <p class="extra-small text-muted mt-2 mb-0">
                                                Determines how significance is calculated when multiple factors are present.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <br>

                                <!-- Sort control removed - now per-variable inside results -->

                                <div class="d-flex flex-wrap mb-4 align-items-center" style="gap: 1.25rem;">
                                    <button id="runAnovaBtn" class="btn btn-success btn-sm">
                                        <i class="bi bi-lightning-fill"></i> Run ANOVA Tests
                                    </button>
                                    <button id="exportFullReportBtn" class="btn btn-outline-success btn-sm" style="display: none;">
                                        <i class="bi bi-file-earmark-excel"></i> Export Full Report
                                    </button>
                                    <span id="exportSpinner" style="display:none;">
                                        <span class="spinner-border spinner-border-sm text-success" role="status"></span>
                                        <span class="small text-muted ms-1">Generating report‚Ä¶</span>
                                    </span>
                                </div>

                                <div id="anovaSpinner" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border text-success" role="status"></div>
                                    <p class="mt-2 text-muted small">Calculating p-values...</p>
                                </div>
                                <div id="anovaResults"></div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="pca-content" role="tabpanel">
                            <div class="p-3">
                                <h5 class="fw-bold mb-3">Principal Component Analysis</h5>
                                <p class="text-muted small">PCA reduces the dimensionality of your data to show relationships between samples and variables.</p>
                                <div class="bg-light p-3 rounded border mb-3">
                                    <h6 class="fw-bold small mb-2 text-uppercase text-muted">Data Preparation</h6>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="pcaRemoveMissing" checked>
                                        <label class="form-check-label small" for="pcaRemoveMissing">Remove rows with missing data (Required for PCA)</label>
                                    </div>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="pcaAverageByFactor">
                                        <label class="form-check-label small" for="pcaAverageByFactor">Average replicates by factor(s) before analysis</label>
                                    </div>
                                </div>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="pcaShowLoadings" checked>
                                    <label class="form-check-label small fw-bold" for="pcaShowLoadings">Plot Variable Loadings (Arrows)</label>
                                </div>
                                <button id="runPCABtn" class="btn btn-primary btn-sm mb-4"><i class="bi bi-play-fill"></i> Run PCA Analysis</button>
                                <div id="pcaResultsHeader" style="display: none;" class="justify-content-between align-items-center mb-3">
                                    <button id="downloadPCAExcelBtn" class="btn btn-outline-success btn-sm"><i class="bi bi-file-earmark-excel"></i> Export PCA Report</button>
                                </div>
                                <div id="pcaSpinner" class="text-center py-4" style="display: none;">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2 text-muted small">Calculating Variance &amp; Generating Biplot...</p>
                                </div>
                                <div id="pcaResults" class="text-center"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Placeholder (shown initially) -->
                <div id="placeholderText" class="text-center py-5">
                    <i class="bi bi-table fs-1 text-muted"></i>
                    <h5 class="mt-3 text-muted">Ready to Analyze</h5>
                    <p class="text-muted">Paste your dataset in the left panel to begin</p>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="{{url_for('static', filename='js_statistics.js')}}"></script>

<div class="modal fade" id="confirmExclusionModal" tabindex="-1" role="dialog" aria-labelledby="confirmExclusionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white border-0 py-2">
                <h6 class="modal-title" id="confirmExclusionModalLabel">
                    <i class="bi bi-trash3-fill me-2"></i> Confirm Outlier Removal
                </h6>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-3">
                <p id="modalMessage" class="small mb-0 text-dark"></p>
                <div class="mt-3 p-2 bg-light rounded shadow-sm" style="font-size: 0.75rem;">
                    <i class="bi bi-info-circle-fill text-primary me-1"></i> 
                    <strong>Note:</strong> After removing, Assumptions and all statistical significance (ANOVA/Letters) should be recalculated.
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light btn-sm px-3" data-dismiss="modal" style="font-size: 0.75rem;">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger btn-sm px-3" style="font-size: 0.75rem;">Remove Point</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}