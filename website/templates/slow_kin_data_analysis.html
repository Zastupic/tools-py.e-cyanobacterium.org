{% extends "base.html" %} 

{% block title %} 
    Slow fluorescence transients analysis
{% endblock %}

{% block content %}
<h1> Analysis of slow chlorophyll fluorescence transients </h1>
<p>Welcome to tool analyzing slow chlorophyll fluorescence induction kinetics! 
This tool enables visualization and analysis of fluorescence traces acquired by several common PAM fluorometers, including 
    <a href="https://www.walz.com/products/chl_p700/multi-color-pam/introduction.html" target="_blank" class="gallery__item--1">MULTI-COLOR-PAM</a>, 
    <a href="https://www.walz.com/products/chl_p700/dual-pam-100/introduction.html" target="_blank" class="gallery__item--2">DUAL-PAM</a>, 
    <a href="https://handheld.psi.cz/products/aquapen-c-and-aquapen-p/#info" target="_blank" class="gallery__item--3">AquaPen</a> or 
    <a href="https://handheld.psi.cz/products/fluorpen-and-par-fluorpen/#info" target="_blank" class="gallery__item--4">FluorPen</a>.
    Up to 50 files can be uploaded simultaneously for batch processing. 
    The tool generates multiple visualizations for the precessed files, including: 
    <ul style="font-size:95%">
        <li>AquaPen / FluorPen:
            <ul>
                <li>Raw fluorescence signals</li>
                <li>Technical parameters of the fluorescence signal, such as <i>F<sub>t</sub></i>, <i>F<sub>M</sub></i> or <i>F<sub>v</sub></i></li>
                <li>Derived parameters: <i>Q<sub>Y</sub></i>, <i>rETR</i>, <i>qP</i>, <i>qN</i> and <i>NPQ</i>
            </ul>
        </li>
        <li>Multi-Color PAM / Dual PAM
            <ul>
                <li>Raw data files
                    <ul>
                        <li>Raw fluorescence signals</li>
                    </ul>
                </li>
                <li>Files with calculated parameters
                    <ul>
                        <li>Technical parameters of the fluorescence signal, such as <i>F<sub>t</sub></i>, <i>F<sub>M</sub></i> or <i>F<sub>v</sub></i></li>
                        <li>Calculated parameters: <i>Q<sub>Y</sub></i>, <i>rETR</i>, <i>qP</i>, <i>qN</i> and <i>NPQ</i></li>
                    </ul>
                </li>
            </ul>
        </li>
    </ul>
    <br>
    The tool is well suited for the analysis of ETR efficiency, NPQ relaxation, state transitions, 
    and other long-term fluorescence responses of cyanobacteria, algae, and higher plants.
    After analysis, all curves and calculated values are compiled into a downloadable .xlsx file for further use. 
    The figure and table below summarizes parameters that can be obtained from the fluorescence kinetics traces.
    For furhter info, see the references provided below, or 
    <a href="https://handheld.psi.cz/documents/AquaPen_Manual-verze_02_2021.pdf" target="blank">NPQ protocols</a>
    available for 
    <a href="https://handheld.psi.cz/products/aquapen-c-and-aquapen-p/#info" target="_blank">AquaPen</a> or
    <a href="https://handheld.psi.cz/products/fluorpen-and-par-fluorpen/#info" target="_blank">FluorPen</a> fluorometers.
</p>
<br>  
<div class="container">
    <div class="images-side-by-side">
        <img src="static/images/NPQ_protocol_examples.jpg" alt="NPQ protocol example" class="gallery__img" data-enlargeable width="50%" style="cursor: zoom-in; width: 25%">
    </div>
</div>
<div style="font-size:70%">
    <i>
        <b>Example protocol modified from:</b>
        Roháček, K. et al., (2008):  Plant cell compartments: selected topics: 41-104. ISBN: 
        <a href="https://faculty.ksu.edu.sa/sites/default/files/CHLOROPHYLL%20FLOURESCENCE.PDF" target="_blank">978-81-308-0104-9</a>
        </i>
</div>  
<br> 
<table style="width:100%">
    <colgroup>
        <col style="width:1%">
        <col style="width:5%">
        <col style="width:6%">
        <col style="width:18%">
    </colgroup>   
    <tr>
        <td><u>Parameter</u></td>
        <td><u>Formula</u></td>
        <td><u>Alternative formula</u></td>
        <td><u>Meaning</u></td>
    </tr>
    <tr>
        <td colspan="4"><i>Technical parameters</i></td>
    </tr>
    <tr>
        <td>F<sub>0</sub></td>
        <td></td>
        <td></td>
        <td>Minimum fluorescence yield in dark-acclimted state</td>
    </tr>
        <tr>
        <td>F<sub>0</sub>'</td>
        <td>F<sub>0</sub> / (F<sub>v</sub> / F<sub>m</sub> + F<sub>0</sub> / F<sub>m</sub>')</td>
        <td></td>
        <td>Minimum fluorescence yield in light-acclimted state (measured in dark, right after the light period)</td>
    </tr>
    <tr>
        <td>F<sub>m</sub></td>
        <td></td>
        <td></td>
        <td>Maximum fluorescence yield in dark-acclimted state, measured during the first saturation flash after dark adaptation</td>
    </tr>
        <td>F<sub>m</sub>'</td>
        <td></td>
        <td></td>
        <td>Maximum fluorescence yields during the course of slow kinetics measurement</td>
    </tr>
    <tr>
        <td>F<sub>m</sub>'<sub> (max)</sub></td>
        <td></td>
        <td></td>
        <td>Maximum fluorescence yield throughout the course of slow kinetics measurement</td>
    </tr>
    <tr>
        <td>F<sub>m</sub>'<sub>D1</sub></td>
        <td></td>
        <td></td>
        <td>Maximum fluorescence yield measured within 1 min after turning of actinic light</td>
    </tr>
    <tr>
        <td>F<sub>m</sub>'<sub>D5</sub></td>
        <td></td>
        <td></td>
        <td>Maximum fluorescence yield measured within 5 min after turning of actinic light</td>
    </tr>
    <tr>
        <td>F<sub>m</sub>'<sub>D20</sub></td>
        <td></td>
        <td></td>
        <td>Maximum fluorescence yield measured within 5 min after turning of actinic light</td>
    </tr>
    <tr>
        <td>F<sub>t</sub></td>
        <td></td>
        <td></td>
        <td>Fluorescence yields during the course of slow kinetics measurement</td>
    </tr>
    <tr>
        <td>F<sub>s</sub></td>
        <td></td>
        <td></td>
        <td>Steady-state fluorescence yield in the light-acclimated state. Also denominated <i>F<sub>s</sub></i></td>
    </tr>
    <tr>
        <td>F<sub>p</sub></td>
        <td></td>
        <td></td>
        <td>Maximum fluorescence yield measured when actinic radiation is switched on</td>
    </tr>
    <tr>
        <td>F<sub>d</sub></td>
        <td>F<sub>p</sub> - F<sub>s</sub></td>
        <td></td>
        <td>Fluorescence decrease from F<sub>p</sub> to F<sub>s</sub></td>
    </tr>
    <tr>
        <td>PAR</td>
        <td></td>
        <td></td>
        <td>Photosynthetically active radiation (units: µmol<sub>photons</sub> m<sup>-2</sup> s<sup>-1</sup>)</td>
    </tr>
    <tr>
        <td>F<sub>v</sub></td>
        <td>F<sub>m</sub> - F<sub>0</sub></td>
        <td></td>
        <td>Variable fluorescence yield in dark-acclimated state with all PSII centers open</td>
    </tr>
     <tr>
        <td>F<sub>v</sub>'</td>
        <td>F<sub>m</sub>' - F<sub>t</td>
        <td></td>
        <td>Variable fluorescence yields during the course of slow kinetics measurement</td>
    </tr>
    <tr>
        <td colspan="4"><i>&nbsp</i></td>
    </tr>
    <tr>
        <td colspan="4"><i>Efficiencies, quantum yields and quenching</i></td>
    </tr>
    <tr>
        <td>F<sub>v</sub> / F<sub>m</sub> (φ<sub>P0</sub>)</td>
        <td>(F<sub>m</sub> - F<sub>0</sub>) / F<sub>m</sub></td>
        <td></td>
        <td>Maximum quantum yield of primary PSII photochemistry, measured in dark-acclimated state</td>
    </tr>
    <tr>
        <td>φ<sub>N0</sub></td>
        <td>F<sub>0</sub> / F<sub>m</sub></td>
        <td></td>
        <td>Basal yield of non-photochemical processes in PSII, measured in dark-acclimated state</td>
    </tr>
    <tr>
        <td>Q<sub>y</sub></td>
        <td>(F<sub>m</sub>' - F<sub>t</sub>) / F<sub>m</sub>'</td>
        <td></td>
        <td>Effective quantum yield of PSII during the course of slow kinetics measurement. 
            Also denominated <i>φ<sub>P</sub></i> or <i>φ<sub>PSII</sub> (PSII operating efficiency)</i>
        </td>
    </tr>
    <tr>
        <td>rETR</td>
        <td>Q<sub>y</sub> * PAR</td>
        <td></td>
        <td>Relative electron transport rate during the course of slow kinetics measurement</td>
    </tr>
    <tr>
        <td>NPQ</td>
        <td>(F<sub>m</sub> - F<sub>m</sub>') / F<sub>m</sub>'</td>
        <td>(F<sub>m</sub>'<sub> (max)</sub> - F<sub>m</sub>') / F<sub>m</sub>'</td>
        <td>Non-photochemical quenching during the course of slow kinetics measurement</td>
    </tr>
    <tr>
        <td>q<sub>CN</sub></td>
        <td>(F<sub>m</sub> - F<sub>m</sub>') / F<sub>m</sub></td>
        <td>(F<sub>m</sub>'<sub> (max)</sub> - F<sub>m</sub>') / F<sub>m</sub>'<sub> (max)</sub></td>
        <td>complete non-photochemical quenching.
           Also denominated <i>q<sub>N</sub> (coefficient of non-photochemical quenching)</i>
        </td>
    </tr>
    <tr>
        <td>q<sub>E</sub></td>
        <td>(F<sub>m</sub>'<sub>D1</sub> - F<sub>m</sub>'<sub>D5</sub>) / F<sub>v</sub></td>
        <td></td>
        <td>Fast (1–5 min) relaxing component of non-photochemical quenching</td>
    </tr>
        <tr>
        <td>q<sub>T</sub></td>
        <td>(F<sub>m</sub>'<sub>D5</sub> - F<sub>m</sub>'<sub>D20</sub>) / F<sub>v</sub></td>
        <td></td>
        <td>Intermediate (10-20 min) relaxing component of non-photochemical quenching</td>
    </tr>
    <tr>
        <td>q<sub>I</sub></td>
        <td>F<sub>m</sub>'<sub>D20</sub> / F<sub>v</sub></td>
        <td></td>
        <td>Very slow (> 20 min) relaxing component of non-photochemical quenching</td>
    </tr>
    <tr>
        <td>q<sub>P</sub></td>
        <td>(F<sub>m</sub>' - F<sub>t</sub>) / (F<sub>m</sub>' - F<sub>0</sub>')</td>
        <td></td>
        <td>Coefficient of photochemical quenching, an estimate of open PSII reaction centers. Also called <i>PSII efficiency factor</i></td>
    </tr>
    <tr>
        <td>R<sub>fd</sub></td>
        <td>F<sub>d</sub> / F<sub>s</sub></td>
        <td></td>
        <td>Variable chlorophyll fluorescence decrease ratio</td>
    </tr>
</table>
<p style="font-size:70%">
    <i>
        <b>References:</b>
        <br>
        Ruban, A. V. (2016): Plant Physiology, 170(4):1903–1916. DOI:
        <a href="https://academic.oup.com/plphys/article/170/4/1903/6114162" target="_blank">10.1104/pp.15.01935</a>
        <br>
        Baker, N. R. (2008): The Annual Review of Plant Biology: 89-113. DOI:
        <a href="https://www.annualreviews.org/content/journals/10.1146/annurev.arplant.59.032607.092759" target="_blank">10.1146/annurev.arplant.59.032607.092759</a>
        <br>
        Lichtenthaler, H. K. et al., (2005): Photosynthetica, 43(3):379-393. DOI:
        <a href="https://ps.ueb.cas.cz/artkey/phs-200503-0009_how-to-correctly-determine-the-different-chlorophyll-fluorescence-parameters-and-the-chlorophyll-fluorescence-d.php" target="_blank">10.1007/s11099-005-0062-6</a>
        <br>
        Roháček, K. (2002): Photosynthetica, 40:13-29. DOI: 
        <a href="https://link.springer.com/article/10.1023/A:1020125719386" target="_blank">10.1023/A:1020125719386</a>
        <br>
        Oxborough, K., Baker, N. R. (1997): Photosynthesis Research, 54:135–142. DOI:
        <a href="https://link.springer.com/article/10.1023/A:1005936823310" target="_blank">10.1023/A:1005936823310</a>
    </i>
</p>
<br>
<u>How to use this tool:</u>
<br>
<ol>
    <li>Select your fluorometer</li>
    <li>Select type of the fluorescence kinetics measurement protocol</li>
    <li>Upload and analyze fluorescence kinetic files (up to 50 files)</li>
    <li>Review the results</li>
    <li>Download the processed results in a summary .xlsx file</li>
</ol>
<br>
<form method="POST" enctype="multipart/form-data" action="{{ url_for('slow_kin_data_analysis.analyze_slow_kin_data', _anchor='results') }}">
    <a style="line-height: 0.9"> <i style="font-size:80%">Accepted file formats include .CSV and .txt files, as obtained by the following fluorometers:</i></a>
    <div class="gallery_6_img">
        <a href="https://www.walz.com/products/chl_p700/multi-color-pam/introduction.html" target="_blank" class="gallery__item--1">
            <i style="font-size:80%">MULTI-COLOR-PAM</i>
            <img src="static/images/MC_PAM.jpg" alt="MULTI-COLOR PAM" class="gallery__item--1">
        </a>
        <a href="https://www.walz.com/products/chl_p700/dual-pam-100/introduction.html" target="_blank" class="gallery__item--2">
            <i style="font-size:80%">DUAL-PAM</i>
            <img src="static/images/dualpam.jpg" alt="Dual PAM" class="gallery__item--2">
        </a>
        <a href="https://handheld.psi.cz/products/aquapen-c-and-aquapen-p/#info" target="_blank" class="gallery__item--3">
            <i style="font-size:80%">AquaPen</i>
            <img src="static/images/aquapen.jpg" alt="Aquapen" class="gallery__item--3">
        </a>
        <a href="https://handheld.psi.cz/products/fluorpen-and-par-fluorpen/#info" target="_blank" class="gallery__item--4">
            <i style="font-size:80%">FluorPen</i>
            <img src="static/images/fluorpen.jpg" alt="FluorPen" class="gallery__item--4">
        </a>
    </div>
    <br>
    <div class="form-group">
        <label for="fluorometer" ><p><b>1. Select fluorometer</b></p></label>
            <select name="fluorometer" id="fluorometer" class="form-control"  aria-label="fluorometer" style="width:100%">
                <option value="MULTI-COLOR-PAM / Dual PAM (Heinz Walz GmbH)">MULTI-COLOR-PAM / Dual PAM (Heinz Walz GmbH)</option>
                <option value="AquaPen / FluorPen (Photon Systems Instruments spol. s r.o.)">AquaPen / FluorPen (Photon Systems Instruments spol. s r.o.)</option>
            </select>
    </div>
    <br>
    <label class="form-label"><p class="font-weight-bold">2a. For AquaPen/FluorPen, select type of the
        <a href="https://handheld.psi.cz/documents/AquaPen_Manual-verze_02_2021.pdf" target="blank"> NPQ protocol</a>:</p></label>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="checkbox_NPQ_Aquapen" id="checkbox_NPQ1" value="checkbox_NPQ1" checked>
        <label class="form-check-label" for="checkbox_NPQ_Aquapen">
            <i> &nbspNPQ protocol 1: <font size="2">Duration: <b>144 s</b>; <b>1</b> pulse in dark; </b><b>5</b> pulses at light (interval: <b>12 s</b>); <b>3</b> pulses in dark (interval: <b>26 s</b>) </i></font>
        </label>
        <br>
        <input class="form-check-input" type="radio" name="checkbox_NPQ_Aquapen" id="checkbox_NPQ2" value="checkbox_NPQ2">
        <label class="form-check-label" for="checkbox_NPQ_Aquapen">
            <i> &nbspNPQ protocol 2: <font size="2">Duration: <b>590 s</b>; <b>1</b> pulse in dark; </b><b>10</b> pulses at light (interval: <b>20 s</b>); <b>7</b> pulses in dark (interval: <b>60 s</b>) </i></font>
        </label>
        <br>
        <input class="form-check-input" type="radio" name="checkbox_NPQ_Aquapen" id="checkbox_NPQ3" value="checkbox_NPQ3">
        <label class="form-check-label" for="checkbox_NPQ_Aquapen">
            <i> &nbspNPQ protocol 3: <font size="2">Duration: <b>260 s</b>; <b>1</b> pulse in dark; </b><b>10</b> pulses at light (interval: <b>21 s</b>); <b>2</b> pulses in dark (interval: <b>21 s</b>) </i></font>
        </label>
    </div>
    <label class="form-label"><p class="font-weight-bold">2b. For MULTI-COLOR PAM, select type of the analyzed file:</p></label>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="checkbox_NPQ_MC_PAM" id="checkbox_file_parameters" value="checkbox_file_parameters" checked>
        <label class="form-check-label" for="checkbox_NPQ_MC_PAM">
            <i> &nbspFile with calculated parameters <font size="2">(.csv file with F<sub>t</sub> and F<sub>m</sub>' values, and derived parameters)</i></font>
        </label>
        <br>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="checkbox_NPQ_MC_PAM" id="checkbox_file_raw_data" value="checkbox_file_raw_data">
        <label class="form-check-label" for="checkbox_NPQ_MC_PAM">
            <i> &nbspRaw data file <font size="2">(.csv file with time and raw fluorescence values only)</i></font>
        </label>
        <br>
    </div>
    <br>
    <div class="form-check">
        <label>
            <input class="form-check-input" type="checkbox" name="checkbox_reduce_file_size" value="checked" checked>
        Reduce size of MULTI-COLOR PAM raw data files
        </label>
    </div>
    <p style="line-height: 0.9"><i style="font-size:80%">
        Please note that MULTI-COLOR PAM files typically contain large data and may take longer time to process.
        For faster processing, it is recommended to reduce size of the MULTI-COLOR PAM files.
        This will also allow to export reduced data to the summary .xlsx file for further processing. Reduced files will contain about 10000 data points.
        <br>If you wish to work with raw data, uncheck the box below. For AquaPen / PlantPen, data reduction is not necessary.
        <br>Please note that it is only possible to work with one file type at a time, although up to 50 files can be processed within a single analysis. 
        The AquaPen/FluorPen files have identical length, due to defined NPQ protocols by the manufacturer. 
        For the MULTI-COLOR PAM files, it is recommended to process only files measured by identical protocols, as defined by the user/experimenter.
        </i>
    </p>
    <table style="width:80%">
        <colgroup>
            <col style="width:1%">
            <col style="width:20%">
            <col style="width:5%">
        </colgroup>  
        <tr>
            <td colspan="3"><u><i>For the MULTI-COLOR PAM files with parameters, following timing is considered for F<sub>0</sub> and F<sub>m</sub></td>
        </tr>
        <tr>
            <td><i>F<sub>0</sub></i></td>
            <td><i>0 s (the first measured F<sub>t</sub> point)</i></td>
            <td></td>
        </tr>
        <tr>
            <td><i>F<sub>m</sub></i></td>
            <td><i>0 s (the first measured F<sub>m</sub> point)</i></td>
            <td></td>
        </tr>
    </table>
    <br>
    <p><b>3. Select files</b></p>
    <div class="custom-file">
        <input 
            type="file" 
            class="custom-file-input" 
            type="file"
            name="NPQ_files"
            id="NPQ_files"
            multiple=""
            accept=".csv, .CSV, .txt, .ASCII"
            style="width:100%">
        <label class="custom-file-label" for="customFile">Select files</label>
    </div>
    <br><br>
    <p><b>4. Analyze slow kinetic files</b></p>
    <br>
    <button id="show-image-button" type="submit" class="btn btn-primary" >Upload and analyze slow kinetic files </button>   
    <a href="{{url_for('static', filename='files/Slow_kin_example_files.zip')}}" download="Slow_kin_example_files">
        <button type="button" class="btn btn-outline-primary">Download example slow kinetic files</button>
    </a>
</form>
<br>
<div class="container">
    <img id="loadingimage" src="{{url_for('static', filename='images/loadingimage.gif')}}" style="display: none;">
</div>

{% if plot_from_memory %}
    <section id="results"></section>   
    <br> <br>
    <h6><b>Measured data: </b></h6>
    <img data-enlargeable width="50%" style="cursor: zoom-in" src="data:image/jpeg;base64,{{ plot_from_memory }}"/>
    <br> <br>
    <form>
        {% if plots_MC_PAM_raw_data %}
            <h6><b>Download results - Multi-Color PAM / Dual PAM, raw data:</b></h6>
            <ul>
                <li>Plots (as shown above)</li>
                <li>Raw fluorescence signals</li>
            </ul>
        {% elif plots_MC_PAM_parameters %}
            <h6><b>Download results - Multi-Color PAM / Dual PAM, parameters:</b></h6>
            <ul>
                <li>Plots (as shown above)</li>
                <li>Calculated parameters</li>
            </ul>
        {% elif plots_AquaPen %}
            <h6><b>Download results - AquaPen / PlantPen:</b></h6>
            <u>AquaPen / PlantPen</u>
            <ul>
                <li>Plots (as shown above)</li>
                <li>Raw fluorescence signals</li>
                <li>Calculated parameters</li>
            </ul>
        </ul>
        {% endif %}
        <br><br>
        <a href="{{ url_for('static', filename=xlsx_file_path)}}">
            <button type="button" class="btn btn-primary">Download the summary .xlsx file</button>
        </a>
    </form>

{% else %}
<br><br><br><br><br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br><br><br>

{% endif %}
<br><br><br><br><br><br><br>

<script src="{{url_for('static', filename='js_slow_kin_analysis.js')}}"></script>

{% endblock %}