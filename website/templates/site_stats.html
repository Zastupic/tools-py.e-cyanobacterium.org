{% extends "base.html" %}

{% block title %}Site Statistics | CyanoTools{% endblock %}
{% block description %}Server-side page view statistics for CyanoTools.{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="mt-3 mb-5">
    <h3>Site Statistics <small class="text-muted" style="font-size:0.75em;">server-side · all visitors · no consent required</small></h3>

    <!-- Summary cards -->
    <div class="row mb-4 mt-3">
        <div class="col-6 col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <div style="font-size:2rem; font-weight:700; color:#17a2b8;">{{ total }}</div>
                    <div class="text-muted" style="font-size:0.85rem;">Total page views</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <div style="font-size:2rem; font-weight:700; color:#28a745;">{{ today_count }}</div>
                    <div class="text-muted" style="font-size:0.85rem;">Views today</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <div style="font-size:2rem; font-weight:700; color:#fd7e14;">{{ unique_today }}</div>
                    <div class="text-muted" style="font-size:0.85rem;">Approx. unique visitors today</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <div style="font-size:2rem; font-weight:700; color:#6f42c1;">{{ month_count }}</div>
                    <div class="text-muted" style="font-size:0.85rem;">Views last 30 days</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily chart -->
    <div class="card mb-4">
        <div class="card-header"><b>Daily page views — last 30 days</b></div>
        <div class="card-body">
            {% if daily_labels %}
            <canvas id="dailyChart" height="80"></canvas>
            {% else %}
            <p class="text-muted mb-0">No data yet — visit a few pages and reload.</p>
            {% endif %}
        </div>
    </div>

    <!-- Top pages table -->
    <div class="card mb-4">
        <div class="card-header"><b>Top pages — last 30 days</b></div>
        <div class="card-body p-0">
            {% if top_pages %}
            <table class="table table-sm table-striped mb-0">
                <thead class="thead-light">
                    <tr><th>Page</th><th style="width:100px; text-align:right;">Views</th></tr>
                </thead>
                <tbody>
                    {% for page in top_pages %}
                    <tr>
                        <td><a href="{{ page.path }}">{{ page.name }}</a></td>
                        <td style="text-align:right;">{{ page.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted p-3 mb-0">No data yet.</p>
            {% endif %}
        </div>
    </div>

    <p class="text-muted" style="font-size:0.8rem;">
        Unique visitors are estimated by counting distinct hashed IPs per day (SHA-256 with a daily salt — raw IPs are never stored).
        Bot traffic (known crawlers) is excluded. Only GET requests are counted.
    </p>
</div>

{% if daily_labels %}
<script>
new Chart(document.getElementById('dailyChart'), {
    type: 'bar',
    data: {
        labels: {{ daily_labels | tojson }},
        datasets: [{
            label: 'Page views',
            data:  {{ daily_counts | tojson }},
            backgroundColor: 'rgba(23, 162, 184, 0.7)',
            borderColor:     'rgba(23, 162, 184, 1)',
            borderWidth: 1,
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            x: { ticks: { maxRotation: 45, font: { size: 11 } } },
            y: { beginAtZero: true, ticks: { precision: 0 } }
        }
    }
});
</script>
{% endif %}
{% endblock %}
